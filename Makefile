# SYNOPSIS:
#
#   make all    - makes everything
#   make main   - makes the main executable..
#   make test   - makes tests.
#   make TARGET - makes the given target.
#   make clean  - removes all files generated by make.


### Common:

# Flags passed to the C++ compiler.
CXXFLAGS += -std=c++14 -g -Wall -Wextra -pthread -O0

all : test main

clean :
	rm -f *.o *.a *.out \
	$(TEST_DIR)/*.o $(TEST_DIR)/*.a $(TEST_DIR)/*.test


### Main section

# SFML linking flags
LFLAGS = -lsfml-system -lsfml-window -lsfml-graphics
IFLAGS = -I.

# All the cpp files to compile
OBJECTS = main.o LSystem.o

# Resulting executable
TARGET = LSystem.out

main : $(OBJECTS)
	$(CXX) $(CXXFLAGS) -o $(TARGET) *.o $(LFLAGS)

%.o : %.cpp
	$(CXX) $(CXXFLAGS) -c $< $(IFLAGS)

### Test section

# Path the root of googletest
GTEST_DIR = /usr/src/googletest/googletest

# Where to find the main code.
CODE_DIR = .

# Where to find the tests.
TEST_DIR = test

# All tests for this project.
TESTS = LSystemTest.test

# Internal googletest variable
GTEST_SRCS_ = $(GTEST_DIR)/src/*.cc $(GTEST_DIR)/src/*.h $(GTEST_HEADERS)

# Flags passed to the preprocessor
GTEST_CPPFLAGS = -isystem $(GTEST_DIR)/include

# Builds the dependencies and the tests
test : $(OBJECTS) $(TESTS)

$(TEST_DIR)/gtest-all.o : $(GTEST_SRCS_)
	$(CXX) $(GTEST_CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest-all.cc -o $@

$(TEST_DIR)/gtest_main.o : $(GTEST_SRCS_)
	$(CXX) $(GTEST_CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest_main.cc -o $@

$(TEST_DIR)/gtest.a : gtest-all.o
	$(AR) $(ARFLAGS) $@ $^

$(TEST_DIR)/gtest_main.a : $(addprefix $(TEST_DIR)/, gtest-all.o gtest_main.o)
	$(AR) $(ARFLAGS) $@ $^

%Test.test : $(TEST_DIR)/%Test.cpp %.o $(TEST_DIR)/gtest_main.a
	$(CXX) $(CPPFLAGS) $(CXXFLAGS) $^ -o $(TEST_DIR)/$@ $(IFLAGS) -lpthread
