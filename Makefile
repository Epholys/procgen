# SYNOPSIS:
#
#   make all    - makes everything.
#   make main    - makes the main executable.
#   make test   - makes tests.
#   make clean  - removes all files generated by make.

# Flags passed to the C++ compiler: common, include and linking flags.
CXXFLAGS += -std=c++14 -g -Wall -Wextra -pthread -O0
LFLAGS += -lsfml-system -lsfml-window -lsfml-graphics
IFLAGS += -I.


# All the .o from the .cpp files of the main project to compile.
OBJECTS = LSystem.o Turtle.o
MAIN    = main.o
MAIN   += $(OBJECTS)
# Main executable
TARGET = procgen.out


# Path the root of googletest
GTEST_DIR = /usr/src/googletest/googletest

# Flags passed to the preprocessor
GTEST_CPPFLAGS = -isystem $(GTEST_DIR)/include

# All Google Test headers.
GTEST_HEADERS = $(GTEST_DIR)/include/gtest/*.h \
                $(GTEST_DIR)/include/gtest/internal/*.h

# Internal googletest variable.
GTEST_SRCS_ = $(GTEST_DIR)/src/*.cc $(GTEST_DIR)/src/*.h $(GTEST_HEADERS)


# Where to find the tests.
TEST_DIR = test

# All tests for this project.
TESTS = $(addprefix $(TEST_DIR)/, LSystemTest.o TurtleTest.o)

# Complete Test Suite executable.
TEST_TARGET = $(TEST_DIR)/procgenTest.out


all : main test

# Cleans all intermediate compilation files.
clean :
	rm -f *.o *.a *.out \
	$(addprefix $(TEST_DIR)/, *.o *.a *.out)


# main: Links all the .o file from MAIN into TARGET.
main : $(MAIN)
	$(CXX) $(CXXFLAGS) -o $(TARGET) $^ $(LFLAGS)

# test: Links all OBJECTS, TESTS files plus gtest_main.a into the test
#       suite TEST_TARGET.
test : $(OBJECTS) $(TESTS) $(TEST_DIR)/gtest_main.a
	$(CXX) $(GTEST_CPPFLAGS) $(CXXFLAGS) -o $(TEST_TARGET) $^ $(IFLAGS) $(LFLAGS) -lpthread


# Each .o file is compiled with its associated *.cpp file.
%.o : %.cpp
	$(CXX) $(CXXFLAGS) -c $^ $(IFLAGS)


# Compiles and archives googletest internals.
#   - gtest_main.a is used when test files are presented without the
#   main() function. gtest.a otherwise.
$(TEST_DIR)/gtest-all.o : $(GTEST_SRCS_)
	$(CXX) $(GTEST_CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest-all.cc -o $@

$(TEST_DIR)/gtest_main.o : $(GTEST_SRCS_)
	$(CXX) $(GTEST_CPPFLAGS) -I$(GTEST_DIR) $(CXXFLAGS) -c \
            $(GTEST_DIR)/src/gtest_main.cc -o $@

$(TEST_DIR)/gtest.a : $(TEST_DIR)/gtest-all.o
	$(AR) $(ARFLAGS)  $@ $^

$(TEST_DIR)/gtest_main.a : $(TEST_DIR)/gtest-all.o $(TEST_DIR)/gtest_main.o
	$(AR) $(ARFLAGS) $@ $^

# Compiles every *Test.cpp.
$(TEST_DIR)/%Test.o : $(TEST_DIR)/%Test.cpp
	$(CXX) $(GTEST_CPPFLAGS) $(CXXFLAGS) -c $^ -o $@ $(IFLAGS)


